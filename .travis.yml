---
dist: bionic
language: python
os: linux
python: "3.7"
sudo: required
env:
  global:
    - VERSION=0.0.1
    - IMAGE_NAME=myimage
    - USERNAME=massipssa
    - CODECOV_TOKEN="337e08e9-8713-4741-88a2-a94f2aad092e"

# stages names from jobs
stages: 
  - test
  - deploy
  - push
  
# services to install
services:
  - docker

jobs:
  include:
    - name: "Test with py 3.7"
      stage: test
      python: "3.7"
      install:
        - make pip-install
     # add codecov
      script:
        - coverage run -m pytest
    - name: "Deploy package to PyPI"
      stage: deploy
      install:
        - make setup
      script:  
        - make deploy
    - name: "Build and push image to Docker Hub"
      stage: push
      script:
        - ./scripts/docker-image.sh push

before_install:
  - chmod +x ./scripts/docker-image.sh
  - make pip-install

# install required dependencies
install: skip

# run the build script
script: skip

after_success:
  - bash <(curl -s https://codecov.io/bash)

# enable or disable notifications
notifications:
  email: false
